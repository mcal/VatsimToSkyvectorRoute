<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Vatsim Route Validator</title>
    
    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Clearance for <span id="callsign"></span><span class="badge badge-danger rounded-pill" id="heavyWeight"></span></h1>
                    </div>

                    <div class="row d-none" id="alertContainer">
                        <div class="mb-4">
                            <div id="alertBorder" class="card border-left-danger shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div id="alertHeader" class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                Alerts</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="alerts">
                                                No alerts
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-check fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">

                            <div class="row">
                                    <!-- Earnings (Annual) Card Example -->
                                <div class="col-md-6 mb-4">
                                    <div class="card border-left-success shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                        Departure</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="depAirportName"></span></div>
                                                    <div><a id="depProcedures" class="text-info">Departure Procedures</a></div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-plane-departure fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <div class="card border-left-danger shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                        Arrival</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="arrAirportName"></span></div>
                                                    <div><a id="arrProcedures" class="text-info">Arrival Procedures</a></div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-plane-arrival fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Basic Card Example -->       
                                
                                <div class="col-md-6 mb-4">
                                    <div class="card border-left-warning shadow h-100 py-2">                                        
                                        <div class="card-body">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Aircraft</div>
                                            <div class="d-flex justify-content-between">
                                                <span id="make" class="d-flex justify-content-between"></span>
                                                <span id="model" class="d-flex justify-content-between"></span> 
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span id="engineType" class="d-flex justify-content-between"></span>
                                                <span id="engineCountLabel" class="d-flex justify-content-between">
                                                    Engine Count: <span id="engineCount" class="d-flex justify-content-between"></span>
                                                </span>                                         
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <div class="card border-left-warning shadow h-100 py-2">                                                                        
                                        <div class="card-body"> 
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Flight</div>
                                            <div class="d-flex justify-content-between">
                                                <span>Altitude</span>
                                                <span id="routeFiledAltitude"></span> 
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Route</span>
                                                <span class="text-warning" id="routeFiled"></span> 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Phraseology</h6>
                                </div>
                                <div class="card-body">
                                    
                                    <div class="d-flex justify-content-between">
                                        <span id="make" class="d-flex justify-content-between"></span>
                                        <span id="model" class="d-flex justify-content-between"></span> 
                                    </div>
                                    <div>
                                        <div>Cleared to <strong><span id="clearanceArrival"></span></strong></div>
                                        <div><strong><span id="sid_dep">[SID DEP]</span> Departure, <span id="useTransition"><span id="sid_trans">[TRANS]</span> transition</span>, then as filed.</strong></div>
                                        <div>Climb and maintain <strong><span id="clearanceInitAlt"></span></strong>. Expect <strong><span id="clearanceFiledAltitude"></span></strong> 1-0 minutes after</strong></div>
                                        <div>Departure Frequecy 125.80</div>
                                        <div>Squawk <strong><span id="clearanceSquawk"></span></strong></div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-lg-6">
                            <!-- Basic Card Example -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Map</h6>
                                </div>
                                <div class="card-body">                                    
                                    <div id="gcMapContainer">
                                        <iframe id="gcMap" width="100%" height="500">                                        
                                        </iframe>
                                    </div>
                                    
                                </div>
                            </div>
                            

                        </div>

                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->



        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/store2@2.14.3/dist/store2.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>
    
    <script src="papaparse.min.js"></script>
    <script src="data/aircraftInfo.js"></script>
    <script src="data/callsignInfo.js"></script>
    <script>
        $(document).ready(function () {

          var alertsCount = 0;

          var urlParams = new URLSearchParams(window.location.search);
          var callsignParam = urlParams.get('callsign').toUpperCase(); 
          var acTypeParam = urlParams.get('acType').toUpperCase(); 
          var depParam = urlParams.get('dep').toUpperCase(); 
          var arrParam = urlParams.get('arr').toUpperCase(); 
          var filedAlt = urlParams.get('filedAlt').toUpperCase(); 
          var routeParam = urlParams.get('route').toUpperCase(); 
          var squawk = urlParams.get('squawk'); 
          
          var depProceduresLink = "https://charts.navigraph.com/airport/" + depParam + "?section=Proc&chartCategory=ARR&informationSection=General&procedureSection=Departures&weatherSection=METAR&ATISSection=Real";
          var arrProceduresLink = "https://charts.navigraph.com/airport/" + arrParam + "?section=Proc&chartCategory=ARR&informationSection=General&procedureSection=Arrivals&weatherSection=METAR&ATISSection=Real";
          $("#depProcedures").attr("href", depProceduresLink);
          $("#arrProcedures").attr("href", arrProceduresLink);


          var callsignInfo = store.get("callsign" + callsignParam.substring(0,3));
          if (!callsignInfo || !callsignInfo.telephony) {
            var filteredCallsigns = callsignJson.filter(function(a) { 
                return a.code.toUpperCase() === callsignParam.substring(0,3).toUpperCase(); 
                });
                callsignInfo = filteredCallsigns[0];
            store.set("callsign" + callsignParam.substring(0,3), callsignInfo);
          }
          $("#callsign").text(callsignParam + " (" + callsignInfo?.telephony + ")");


          $("#routeFiled").text(routeParam);
          
          $("#routeFiledAltitude").text(filedAlt);
          $("#clearanceFiledAltitude").text(filedAlt);          
          $("#clearanceSquawk").text(squawk);

            //var gcMapUrl = "http://www.gcmap.com/map?P=" + depParam + "-" + arrParam + "&MS=wls&MR=60&MX=540x540&PM=*";
            var gcMapUrl = "https://www.greatcirclemap.com/roadmap?label=icao&unit=mi&routes=" + depParam + "-" + arrParam;
            document.getElementById('gcMap').src = gcMapUrl;            
            $("#gcMapContainer").append($("iframe").attr("src", gcMapUrl));

          // Converts from degrees to radians.
          function toRadians(degrees) {
            return degrees * Math.PI / 180;
          };
          
          // Converts from radians to degrees.
          function toDegrees(radians) {
            return radians * 180 / Math.PI;
          }

          function getBearing(startLat, startLng, destLat, destLng){
            startLat = toRadians(startLat);
            startLng = toRadians(startLng);
            destLat = toRadians(destLat);
            destLng = toRadians(destLng);

            y = Math.sin(destLng - startLng) * Math.cos(destLat);
            x = Math.cos(startLat) * Math.sin(destLat) -
                  Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
            brng = Math.atan2(y, x);
            brng = toDegrees(brng);
            return (brng + 360) % 360;
          }
          
            var aircraft = store.get("acInfo" + acTypeParam);
            if (!aircraft || !aircraft.make || !aircraft.model || !aircraft.engineType || !aircraft.engineCount) {
                var filteredAircraft = acJson.filter(function(a) { 
                    return a.acType.toUpperCase() === acTypeParam.toUpperCase(); 
                  });
                aircraft = filteredAircraft[0];
                store.set("acInfo" + acTypeParam, aircraft);
            }
            $("#make").text(aircraft.make);
            $("#model").text(aircraft.model);
            $("#engineType").text(aircraft.engineType);
            $("#engineCount").text(aircraft.engineCount);
            if (aircraft.weight == "Heavy") { $("#heavyWeight").html(aircraft.weight);}

            var initAltitude = 5000;
            switch(depParam.toUpperCase()) {
                case "KMEM":
                    if (!aircraft.engineType.toUpperCase() == "JET") {
                        initAltitude = 4000 

                    }
                    else { 
                        initAltitude = 5000;
                    }
                    break;
                case "KBNA":
                case "KLIT":
                case "KJAN":
                    initAltitude = 4000;
                    break;
                case "KXNA":
                case "KHSV":
                    initAltitude = 5000;
                    break;
                default:                    
                    initAltitude = 5000;
            }

            $("#clearanceInitAlt").text(initAltitude);
            $("#engineCount").text(aircraft.engineCount);

            var departureAirport = store.get("airport" + depParam);
            var arrivalAirport = store.get("airport" + arrParam);
            var airportData;

            if (!departureAirport || !arrivalAirport) 
            {
                airportData = store.get("aiportData");
                if (!airportData) {
                    Papa.parse("data/iata-icao.csv", {
                        download: true,
                        header: true,            
                        dynamicTyping: true,
                        complete: function(results) {
                            console.log(results);
                            airportData = results.data;
                            store.set("airportData", airportData)
                            getAirports();
                        }
                    });
                }
                else
                {
                    getAirports();
                }
            }
            else
            {
                validateAltitude();
            }

            //Try to find DEP in live data            
            var route;
            var lastDataUpdate = store.get("lastDataUpdate");
            const dateDifferenceInSeconds = (dateInitial, dateFinal) => (dateFinal - dateInitial) / 1_000;
            if (!lastDataUpdate || dateDifferenceInSeconds(new Date(lastDataUpdate), new Date(), 's') > 15) {
                $.ajax({ 
                        type: 'GET', 
                        url: 'https://data.vatsim.net/v3/vatsim-data.json',               
                        success: function (data) { 
                            store.set("lastDataUpdate", data.general.update_timestamp);
                            store.set("lastData", data);

                            getFlight(data);
                        },
                        failure: function() {
                            CheckJetTimeRestictedSid(routeParam.split(" "));
                        }
                });
            }
            else
            {
                var lastData = store.get("lastData");
                getFlight(lastData);
            }

            function getFlight(data)
            {
                var onlineFlights = data.pilots;
                var filteredFlight = onlineFlights.filter(function(t) { 
                    return t.callsign.toUpperCase() === callsignParam.toUpperCase(); 
                });
                if (filteredFlight && filteredFlight.length > 0) {
                    var flight = filteredFlight[0];
                    route = flight.flight_plan.route;
                    
                    $("#routeFiled").text(route).removeClass("text-warning").addClass("text-success");

                    const waypoints = route.split(' ');
                    $("#sid_dep").text(waypoints[0] ?? "");
                    $("#sid_trans").text(waypoints[1] ?? "Unknown");

                    CheckJetTimeRestictedSid(waypoints);
                }
                else {
                    CheckJetTimeRestictedSid(routeParam.split(" "));    
                }
            }

            function CheckJetTimeRestictedSid(waypoints) {
                $("#sid_dep").text(waypoints[0] ?? "");
                $("#sid_trans").text(waypoints[1] ?? "Unknown");

                if (depParam == "KMEM") {                                
                    var timeRestrictedJetSids = ['BINKY','GENEH','GMBUD','GRRIZ','HOTRD','NIKEI','OLEMS']; //JET - Time Restricted
                    var jetSids = ['BBKNG','CHLDR','CRSON','DUCKZ','GOETZ','JTEEE','PIEPE','SELPH','ZUMIT'].concat(timeRestrictedJetSids); //JET - All Day
                    
                    var jetRoute = jetSids.some(item => waypoints[0].startsWith(item));
                    
                    var timeRestricted = (timeRestrictedJetSids.some(item => waypoints[0].startsWith(item)) //If a time restricted jet sid
                            || waypoints.some(item => { //Or has one of the ELVIS4 waypoints
                                ['SFOUR','STREE','NFIVE','EFOUR','NRONE','WFIVE','WFOUR','SONEI'].includes(item.toUpperCase());
                            }));
                    
                    if (jetRoute && !(aircraft.engineType.toUpperCase() == "JET")) { addAlert("INVALID SID - JETS ONLY"); }

                    if (timeRestricted) {
                        date = new Date(0);
                        var centralHour = date.toLocaleString('en-US', {hour: '2-digit',   hour12: false, timeZone: 'America/Chicago' });                                    
                        if (centralHour <2 || centralHour > 6) { addAlert("INVALID SID - TIME RESTRICTED"); }
                    }
                }

            }

            function getAirports() {
                departureAirport = airportData.filter(function(a) { 
                    return a.icao?.toUpperCase() === depParam.toUpperCase(); 
                })[0];
                store.set("airport" + depParam, departureAirport);                
                
                arrivalAirport = airportData.filter(function(a) { 
                    return a.icao?.toUpperCase() === arrParam.toUpperCase(); 
                })[0];
                store.set("airport" + arrParam, arrivalAirport);
                                
                validateAltitude();
            }

            function validateAltitude() {
                $("#depAirportName").text(departureAirport.airport);
                $("#arrAirportName").text(arrivalAirport.airport);
                $("#clearanceArrival").text(arrivalAirport.airport);
                
                var bearing = getBearing(departureAirport.latitude, departureAirport.longitude, arrivalAirport.latitude, arrivalAirport.longitude);
                var filedAltNumber;
                
                if (filedAlt.startsWith("FL")) {
                    filedAltNumber = filedAlt.match(/\d+/gi) * 100;
                }
                else {
                    filedAltNumber = filedAlt;
                }
                var filedAltThousand = filedAltNumber / 1000;
                var isOdd = filedAltThousand % 2;
                
                if (bearing >= 180 && bearing <= 359) {
                //Even - South West
                if (((filedAltThousand != '43') && (filedAltThousand != '47') && (filedAltThousand != '51')) &&
                isOdd)
                addAlert("Invalid Flight Level - Need Even");
                } 
                else
                {
                //Odd - North East
                if (((filedAltThousand == 43) && (filedAltThousand == 47) && (filedAltThousand == 51)) ||
                !isOdd)
                addAlert("Invalid Flight Level - Need Odd");
                }

                if (alertsCount > 0) {                    
                    $("#alertBorder").removeClass("border-left-info");
                    $("#alertBorder").addClass("border-left-danger");
                    $("#alertHeader").removeClass("text-info");
                    $("#alertHeader").addClass("text-danger");
                }
            }

            function addAlert(text)
            {                
                if (alertsCount == 0)
                {
                    $("#alerts").text("");                    
                }                
                var newAlert = $("<div />").addClass("alert alert-danger").attr("role", "alert").text(text);
                $("#alerts").append(newAlert);
                $("#alertContainer").removeClass("d-none");
                alertsCount++;   
            }
        });

    </script>

</body>

</html>